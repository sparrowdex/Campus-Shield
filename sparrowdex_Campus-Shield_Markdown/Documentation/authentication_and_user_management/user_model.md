# User Model

## User Model Implementation

<document-code-reference section="User Model Implementation">
{"files": [
  {
    "name": "Campus-Shield/server/models/User.js",
    "description": "JavaScript/TypeScript implementation file containing data models and entity definitions",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/User.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/models"
  },
  {
    "name": "Campus-Shield/server/models/Report.js",
    "description": "JavaScript/TypeScript implementation file containing data models and entity definitions",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/Report.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/models"
  },
  {
    "name": "Campus-Shield/server/index.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server"
  },
  {
    "name": "Campus-Shield/client/src/index.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/index.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src"
  }
]}
</document-code-reference>

The User Model in the Campus-Shield project is a crucial component that handles user data management, authentication, and authorization. It is implemented using Mongoose for MongoDB integration and includes various fields and methods to support the application's security and privacy features.

<artifact ArtifactUUID="d68b5d6e-e9c4-4128-a847-bd58e1c3702d">Core Schema Definition</artifact>

```javascript
const userSchema = new mongoose.Schema({
  anonymousId: {
    type: String,
    required: true,
    unique: true,
    index: true
  },
  email: {
    type: String,
    sparse: true,
    lowercase: true,
    match: [/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/, 'Please enter a valid email']
  },
  password: {
    type: String,
    minlength: 6
  },
  role: {
    type: String,
    enum: ['user', 'admin', 'moderator'],
    default: 'user'
  },
  isAnonymous: {
    type: Boolean,
    default: true
  },
  campusId: {
    type: String,
    index: true
  },
  // ... other fields
});
```

### Key Features

1. **Anonymous Reporting**: The model supports anonymous users through the `anonymousId` field, allowing incident reporting without personal identification.

2. **Role-based Access Control**: The `role` field enables differentiation between regular users, administrators, and moderators, facilitating granular access control throughout the application.

3. **Privacy-First Approach**: The `isAnonymous` flag and optional email/password fields allow users to choose their level of identity disclosure.

4. **Data Retention Policy**: Implements a `dataRetentionDate` field to comply with data protection regulations and user privacy.

<artifact ArtifactUUID="fadcff8f-1134-4947-847e-ff562f07b436">Security Measures</artifact>

```javascript
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  
  if (this.password) {
    const salt = await bcrypt.genSalt(parseInt(process.env.BCRYPT_ROUNDS) || 12);
    this.password = await bcrypt.hash(this.password, salt);
  }
  
  this.updatedAt = Date.now();
  next();
});

userSchema.methods.comparePassword = async function(candidatePassword) {
  if (!this.password) return false;
  return bcrypt.compare(candidatePassword, this.password);
};
```

### Security Implementation

1. **Password Hashing**: Utilizes bcrypt for secure password hashing before storage.
2. **Comparison Method**: Provides a `comparePassword` method for secure password verification during authentication.

<artifact ArtifactUUID="6a424ad5-5ffa-42b1-8cee-8661c8853c8d">User Management Methods</artifact>

```javascript
userSchema.methods.updateLastActive = function() {
  this.lastActive = new Date();
  return this.save();
};

userSchema.statics.createAnonymousUser = function(anonymousId, campusId = null) {
  return this.create({
    anonymousId,
    campusId,
    isAnonymous: true
  });
};
```

### User Management Features

1. **Activity Tracking**: The `updateLastActive` method allows for monitoring user engagement.
2. **Anonymous User Creation**: Facilitates the creation of anonymous users with minimal required information.

## Integration with Authentication System

<document-code-reference section="Integration with Authentication System">
{"files": [
  {
    "name": "Campus-Shield/server/models/User.js",
    "description": "JavaScript/TypeScript implementation file containing data models and entity definitions",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/User.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/models"
  },
  {
    "name": "Campus-Shield/server/middleware/moderator.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/middleware/moderator.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/middleware"
  },
  {
    "name": "Campus-Shield/server/routes/auth.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/auth.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/routes"
  },
  {
    "name": "Campus-Shield/server/index.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server"
  }
]}
</document-code-reference>

The User Model integrates closely with the authentication system, implemented in `server/routes/auth.js` and `client/src/contexts/AuthContext.tsx`.

```javascript
// server/routes/auth.js
router.post('/register', [
  // ... validation middleware
], async (req, res) => {
  // User creation logic
});

router.post('/login', [
  // ... validation middleware
], async (req, res) => {
  // User authentication logic
});

router.post('/anonymous', [
  // ... validation middleware
], async (req, res) => {
  // Anonymous user creation logic
});
```

The authentication routes leverage the User Model's methods for user creation, verification, and token generation, ensuring a secure and privacy-focused user management system.

## Admin Request Handling

<document-code-reference section="Admin Request Handling">
{"files": [
  {
    "name": "Campus-Shield/server/routes/admin.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/admin.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/routes"
  },
  {
    "name": "Campus-Shield/client/src/pages/RequestAdmin.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/RequestAdmin.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages"
  },
  {
    "name": "Campus-Shield/server/index.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server"
  },
  {
    "name": "Campus-Shield/client/src/index.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/index.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src"
  }
]}
</document-code-reference>

The system includes an AdminRequest model (`server/models/AdminRequest.js`) to manage requests for elevated privileges:

```javascript
const AdminRequestSchema = new Schema({
  userId: { type: Schema.Types.ObjectId, ref: 'User', required: true },
  reason: { type: String, required: true },
  role: { type: String, required: true },
  // ... other fields
  status: { type: String, enum: ['pending', 'approved', 'rejected'], default: 'pending' }
});
```

This model works in conjunction with the User Model to handle the process of granting administrative or moderator roles to users, maintaining the integrity of the role-based access control system.

The User Model's comprehensive design and integration with authentication and authorization components form the backbone of the Campus-Shield application's user management system, prioritizing security, privacy, and flexibility in user interactions.
## References:
### Code:
<code-reference uuid='4cf5eaf2-d3f8-4490-8527-039584822f55'>[{"file_name": "Campus-Shield/server/index.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js", "markdown_link": "- [Campus-Shield/server/index.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js)\n", "code_chunk": "const express = require('express');\nconst http = require('http');\nconst socketIo = require('socket.io');\nconst cors = require('cors');\nconst helmet = require('helmet');\nconst compression = require('compression');\nconst morgan = require('morgan');\nconst rateLimit = require('express-rate-limit');\nconst path = require('path');\nrequire('dotenv').config();\nconst mongoose = require('mongoose');\n\n// Debug environment variables\nconsole.log('\ud83d\udd0d Environment variables check:');\nconsole.log('NODE_ENV:', process.env.NODE_ENV);\nconsole.log('PORT:', process.env.PORT);\nconsole.log('MONGODB_URI exists:', !!process.env.MONGODB_URI);\nconsole.log('MONGODB_URI length:', process.env.MONGODB_URI ? process.env.MONGODB_URI.length : 0);\nconsole.log('All env vars:', Object.keys(process.env).filter(key => key.includes('MONGO') || key.includes('MONGODB')));\n\nconst connectDB = require('./config/database');\nconst authRoutes = require('./routes/auth');\nconst reportRoutes = require('./routes/reports');\nconst chatRoutes = require('./routes/chat');\nconst adminRoutes = require('./routes/admin');\nconst notificationsRoutes = require('./routes/notifications');\nconst { initializeSocket } = require('./services/socketService');\nconst { errorHandler } = require('./middleware/errorHandler');\n\nconst app = express();\nconst server = http.createServer(app);\nconst io = socketIo(server, {\n  cors: {\n    origin: process.env.CORS_ORIGIN || \"http://localhost:3000\",\n    methods: [\"GET\", \"POST\"]\n  }\n});\n\n// Connect to MongoDB (non-blocking)\nconnectDB().catch(err => {\n  console.error('Failed to connect to database:', err);\n  // Don't exit the process, let it continue\n});\n\n// Initialize Socket.io\ninitializeSocket(io);\n\n// Security middleware\napp.use(helmet({\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n      scriptSrc: [\"'self'\"],\n      imgSrc: [\"'self'\", \"[REMOVED_DATA_URI]\n      connectSrc: [\"'self'\", \"ws:\", \"wss:\"]\n    }\n  }\n}));\n\n// Rate limiting\nconst limiter = rateLimit({\n  windowMs: parseInt(process.env.RATE_LIMIT_WINDOW) || 15 * 60 * 1000, // 15 minutes\n  max: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS) || 100,\n  message: 'Too many requests from this IP, please try again later.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\napp.use('/api/', limiter);\n\n// Middleware\napp.use(compression());\napp.use(morgan('combined'));\n// Apply CORS globally before all routes\nconst allowedOrigins = process.env.CORS_ORIGIN\n  ? process.env.CORS_ORIGIN.split(',').map(origin => origin.trim())\n  : [\"http://localhost:3000\"];\nconsole.log('Allowed CORS origins:', allowedOrigins);\n\napp.use(cors({\n  origin: function(origin, callback) {\n    if (!origin) return callback(null, true);\n    if (allowedOrigins.includes(origin)) return callback(null, true);\n    return callback(new Error('Not allowed by CORS'));\n  },\n  credentials: true\n}));\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// Serve uploaded files\napp.use('/uploads', express.static(path.join(__dirname, 'uploads')));\n\n// Health check endpoint\napp.get('/health', (req, res) => {\n  const health = {\n    status: 'OK',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    environment: process.env.NODE_ENV || 'development',\n    database: mongoose.connection.readyState === 1 ? 'connected' : 'disconnected'\n  };\n  \n  res.status(200).json(health);\n});\n\n// API Routes\napp.use('/api/auth', authRoutes);\napp.use('/api/reports', reportRoutes);\napp.use('/api/chat', chatRoutes);\napp.use('/api/admin', adminRoutes);\napp.use('/api/notifications', notificationsRoutes);\n\n// Error handling middleware\napp.use(errorHandler);\n\n// 404 handler\napp.use('*', (req, res) => {\n  res.status(404).json({\n    success: false,\n    message: 'Route not found'\n  });\n});\n\nconst PORT = process.env.PORT || 5000;"}, {"file_name": "Campus-Shield/server/routes/reports.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/reports.js", "markdown_link": "- [Campus-Shield/server/routes/reports.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/reports.js)\n", "code_chunk": "const express = require('express');\nconst multer = require('multer');\nconst path = require('path');\nconst { body, validationResult, query } = require('express-validator');\nconst Report = require('../models/Report');\nconst auth = require('../middleware/auth');\nconst { categorizeReport, analyzeSentiment } = require('../services/aiService');\nconst memoryStore = require('../services/memoryStore');\n\nconst router = express.Router();\n\n// Check if MongoDB is connected\nconst isMongoConnected = () => {\n  return Report.db && Report.db.readyState === 1;\n};\n\n// Configure multer for file uploads\nconst storage = multer.diskStorage({\n  destination: (req, file, cb) => {\n    cb(null, 'uploads/');\n  },\n  filename: (req, file, cb) => {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));\n  }\n});\n\nconst upload = multer({\n  storage: storage,\n  limits: {\n    fileSize: 10 * 1024 * 1024, // 10MB limit\n  },\n  fileFilter: (req, file, cb) => {\n    const allowedTypes = /jpeg|jpg|png|gif|mp4|avi|mov|wav|mp3|pdf/;\n    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());\n    const mimetype = allowedTypes.test(file.mimetype);\n    \n    if (mimetype && extname) {\n      return cb(null, true);\n    } else {\n      cb(new Error('Only image, video, audio, and PDF files are allowed'));\n    }\n  }\n});\n\n// @route   POST /api/reports\n// @desc    Submit a new incident report\n// @access  Private\nrouter.post('/', auth, upload.array('attachments', 5), [\n  body('title').isLength({ min: 5, max: 200 }).withMessage('Title must be between 5 and 200 characters'),\n  body('description').isLength({ min: 10, max: 2000 }).withMessage('Description must be between 10 and 2000 characters'),\n  body('category').isIn([\n    'harassment', 'assault', 'theft', 'vandalism', 'suspicious_activity',\n    'emergency', 'safety_hazard', 'discrimination', 'bullying', 'other'\n  ]).withMessage('Invalid category'),\n  // Add a custom sanitizer for coordinates\n  body('location.coordinates').customSanitizer(value => {\n    if (typeof value === 'string') {\n      try {\n        return JSON.parse(value);\n      } catch {\n        return value;\n      }\n    }\n    return value;\n  }),\n  body('location.coordinates').isArray({ min: 2, max: 2 }).withMessage('Location coordinates are required'),\n  body('location.coordinates.*').isFloat().withMessage('Coordinates must be numbers'),\n  body('incidentTime').optional().isISO8601().withMessage('Invalid date format')\n], async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({ success: false, errors: errors.array() });\n    }\n\n    const {\n      title,\n      description,\n      category,\n      location,\n      incidentTime\n    } = req.body;\n\n    // Get user info\n    const user = req.user;\n\n    // Process attachments\n    const attachments = req.files ? req.files.map(file => ({\n      filename: file.filename,\n      originalName: file.originalname,\n      mimetype: file.mimetype,\n      size: file.size,\n      path: file.path\n    })) : [];\n\n    // Parse coordinates if sent as a string\n    let coordinates = location.coordinates;\n    if (typeof coordinates === 'string') {\n      try {\n        coordinates = JSON.parse(coordinates);\n      } catch (e) {\n        coordinates = undefined;\n      }\n    }\n\n    // Create report data\n    const reportData = {\n      reporterId: user.userId,\n      title,\n      description,\n      category,\n      location: {\n        type: 'Point',\n        coordinates: coordinates || location.coordinates,\n        address: location.address || '',\n        building: location.building || '',\n        floor: location.floor || ''\n      },\n      incidentTime: incidentTime || new Date(),\n      attachments,\n      isAnonymous: user.isAnonymous || true,\n      ipAddress: req.ip,\n      userAgent: req.get('User-Agent')\n    };"}, {"file_name": "Campus-Shield/SETUP_GUIDE.md", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/SETUP_GUIDE.md", "markdown_link": "- [Campus-Shield/SETUP_GUIDE.md](https://github.com/sparrowdex/Campus-Shield/blob/main/SETUP_GUIDE.md)\n", "code_chunk": "# \ud83d\udee1\ufe0f CampusShield Setup Guide for Beginners\n\n## \ud83d\udccb Table of Contents\n1. [What is CampusShield?](#what-is-campusshield)\n2. [Cloning from GitHub](#cloning-from-github)\n3. [Prerequisites](#prerequisites)\n4. [Installation Steps](#installation-steps)\n5. [Running the Application](#running-the-application)\n6. [Understanding the Project Structure](#understanding-the-project-structure)\n7. [Common Issues & Solutions](#common-issues--solutions)\n8. [Development Workflow](#development-workflow)\n9. [Testing the Features](#testing-the-features)\n10. [Contributing](#contributing)\n\n---\n\n## \ud83c\udfaf What is CampusShield?\n\nCampusShield is a **privacy-first campus safety platform** that allows students to:\n- **Report incidents anonymously** with location tracking\n- **Chat securely** with campus authorities\n- **Track report status** and updates\n- **View safety analytics** and heatmaps\n\n---\n\n## \ud83d\ude80 Cloning from GitHub\n\nIf you are starting from the GitHub repository:\n```bash\ngit clone https://github.com/YOUR_USERNAME/YOUR_REPO.git\ncd CampusShield\n```\n\n---\n\n## \ud83d\udccb Prerequisites\n\nBefore you start, make sure you have these installed:\n\n### **Required Software:**\n- \u2705 **Node.js** (v16 or higher) - [Download here](https://nodejs.org/)\n- \u2705 **MongoDB** (v5 or higher) - [Download here](https://www.mongodb.com/try/download/community)\n- \u2705 **Git** (optional) - [Download here](https://git-scm.com/)\n\n### **How to Check if Installed:**\nOpen Command Prompt and type:\n```bash\nnode --version\nnpm --version\nmongod --version\n```\n\n---\n\n## \ud83d\ude80 Installation Steps\n\n### **Step 1: Download the Project**\n1. **Download** the CampusShield project files (or clone from GitHub)\n2. **Extract** to a folder (e.g., `C:\\CampusShield`)\n3. **Open Command Prompt** in that folder\n\n### **Step 2: Install Dependencies**\n```bash\n# Install backend dependencies\ncd server\nnpm install\n\n# Install frontend dependencies\ncd ../client\nnpm install\n```\n\n### **Step 3: Set Up MongoDB**\n1. **Download MongoDB** from [mongodb.com](https://www.mongodb.com/try/download/community)\n2. **Install with default settings** (Complete installation)\n3. **MongoDB will run as a Windows Service** (starts automatically)\n\n### **Step 4: Create Environment File**\n1. **Navigate to server folder**: `cd server`\n2. **Copy `.env.example` to `.env`**:\n   ```bash\n   copy .env.example .env\n   # Or manually create .env and copy the contents from .env.example\n   ```\n3. **Edit `.env` as needed** (set your MongoDB URI, JWT secret, etc.)\n\n### **Step 5: (Optional) Seed Admin/Moderator Accounts**\nIf you want demo admin/moderator accounts, run:\n```bash\ncd server\nnode seedAdmins.js\n```\n\n---\n\n## \ud83c\udfc3\u200d\u2642\ufe0f Running the Application\n\n### **You Need 2 Command Prompt Windows:**\n\n#### **Window 1: Backend Server**\n```bash\ncd server\nnpm run dev\n```\n**Expected Output:**\n```\n\ud83d\udce6 MongoDB Connected: localhost\n\ud83d\ude80 CampusShield server running on port 5000\n\ud83d\udcca Health check: http://localhost:5000/health\n\ud83d\udd12 Environment: development\n```\n\n#### **Window 2: Frontend Server**\n```bash\ncd client\nnpm start\n```\n**Expected Output:**\n```\nCompiled successfully!\n\nYou can now view campus-shield in the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://192.168.x.x:3000\n```\n\n### **Access the Application:**\n- **Frontend**: http://localhost:3000\n- **Backend API**: http://localhost:5000\n- **Health Check**: http://localhost:5000/health\n\n---\n\n## \ud83d\udcf1 Mobile Responsiveness\nCampusShield is fully mobile responsive and works best on modern browsers. For the best experience, use Chrome, Firefox, or Edge on desktop or mobile.\n\n---\n\n## \ud83d\udcc1 Understanding the Project Structure"}, {"file_name": "Campus-Shield/server/models/AdminRequest.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/AdminRequest.js", "markdown_link": "- [Campus-Shield/server/models/AdminRequest.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/AdminRequest.js)\n", "code_chunk": "const mongoose = require('mongoose');\nconst { Schema } = mongoose;\n\nconst AdminRequestSchema = new Schema({\n  userId: { type: Schema.Types.ObjectId, ref: 'User', required: true },\n  reason: { type: String, required: true },\n  role: { type: String, required: true },\n  department: { type: String, required: true },\n  experience: { type: String, required: true },\n  responsibilities: { type: String, required: true },\n  urgency: { type: String, enum: ['low', 'medium', 'high', 'critical'], required: true },\n  contactInfo: { type: String },\n  status: { type: String, enum: ['pending', 'approved', 'rejected'], default: 'pending' },\n  createdAt: { type: Date, default: Date.now },\n  reviewedBy: { type: Schema.Types.ObjectId, ref: 'User' },\n  reviewedAt: { type: Date },\n  reviewNotes: { type: String }\n});\n\nmodule.exports = mongoose.model('AdminRequest', AdminRequestSchema);"}, {"file_name": "Campus-Shield/server/services/memoryStore.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/memoryStore.js", "markdown_link": "- [Campus-Shield/server/services/memoryStore.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/memoryStore.js)\n", "code_chunk": "// Admin request operations\n  createAdminRequest(userId, requestData) {\n    const request = {\n      id: this.nextRequestId.toString(),\n      userId,\n      ...requestData,\n      status: 'pending', // pending, approved, rejected\n      createdAt: new Date().toISOString(),\n      reviewedBy: null,\n      reviewedAt: null,\n      reviewNotes: null\n    };\n    this.adminRequests.set(request.id, request);\n    this.nextRequestId++;\n    return request;\n  }\n\n  getAdminRequests(status = null) {\n    const requests = Array.from(this.adminRequests.values());\n    if (status) {\n      return requests.filter(req => req.status === status);\n    }\n    return requests;\n  }\n\n  updateAdminRequest(requestId, updates) {\n    const request = this.adminRequests.get(requestId);\n    if (request) {\n      Object.assign(request, updates, { \n        reviewedAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString()\n      });\n      this.adminRequests.set(requestId, request);\n      return request;\n    }\n    return null;\n  }\n\n  approveAdminRequest(requestId, approvedBy, notes = '') {\n    const request = this.updateAdminRequest(requestId, {\n      status: 'approved',\n      reviewedBy: approvedBy,\n      reviewNotes: notes\n    });\n\n    if (request) {\n      // Promote user to admin\n      this.updateUser(request.userId, { role: 'admin' });\n    }\n\n    return request;\n  }\n\n  rejectAdminRequest(requestId, rejectedBy, notes = '') {\n    return this.updateAdminRequest(requestId, {\n      status: 'rejected',\n      reviewedBy: rejectedBy,\n      reviewNotes: notes\n    });\n  }\n\n  // Report operations\n  createReport(reportData) {\n    const report = {\n      id: this.nextReportId.toString(),\n      ...reportData,\n      status: 'pending',\n      priority: 'medium',\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString(),\n      attachments: [],\n      publicUpdates: []\n    };\n    this.reports.set(report.id, report);\n    this.nextReportId++;\n    return report;\n  }\n\n  findReportsByUserId(userId) {\n    const userReports = [];\n    for (const report of this.reports.values()) {\n      if (report.userId === userId) {\n        userReports.push(report);\n      }\n    }\n    return userReports;\n  }\n\n  findReportById(id) {\n    return this.reports.get(id) || null;\n  }\n\n  updateReport(id, updates) {\n    const report = this.reports.get(id);\n    if (report) {\n      Object.assign(report, updates, { updatedAt: new Date().toISOString() });\n      this.reports.set(id, report);\n      return report;\n    }\n    return null;\n  }\n\n  // Chat operations\n  createChatRoom(roomData) {\n    const room = {\n      roomId: this.nextRoomId.toString(),\n      ...roomData,\n      createdAt: new Date().toISOString(),\n      lastMessage: null\n    };\n    this.chatRooms.set(room.roomId, room);\n    this.nextRoomId++;\n    return room;\n  }\n\n  findChatRoomByReportId(reportId) {\n    for (const room of this.chatRooms.values()) {\n      if (room.reportId === reportId) {\n        return room;\n      }\n    }\n    return null;\n  }\n\n  findChatRoomsByUserId(userId) {\n    const userRooms = [];\n    for (const room of this.chatRooms.values()) {\n      if (room.userId === userId) {\n        userRooms.push(room);\n      }\n    }\n    return userRooms;\n  }\n\n  createMessage(messageData) {\n    const message = {\n      id: this.nextMessageId.toString(),\n      ...messageData,\n      timestamp: new Date().toISOString()\n    };\n    this.messages.set(message.id, message);\n    this.nextMessageId++;\n    return message;\n  }\n\n  findMessagesByRoomId(roomId) {\n    const roomMessages = [];\n    for (const message of this.messages.values()) {\n      if (message.roomId === roomId) {\n        roomMessages.push(message);\n      }\n    }\n    return roomMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n  }\n\n  // Admin operations\n  getAllReports() {\n    return Array.from(this.reports.values());\n  }\n\n  getAllUsers() {\n    return Array.from(this.users.values());\n  }"}, {"file_name": "Campus-Shield/server/routes/auth.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/auth.js", "markdown_link": "- [Campus-Shield/server/routes/auth.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/auth.js)\n", "code_chunk": "const express = require('express');\nconst bcrypt = require('bcryptjs');\nconst jwt = require('jsonwebtoken');\nconst { v4: uuidv4 } = require('uuid');\nconst { body, validationResult } = require('express-validator');\nconst User = require('../models/User');\nconst auth = require('../middleware/auth');\nconst memoryStore = require('../services/memoryStore');\nconst AdminRequest = require('../models/AdminRequest');\n\nconst router = express.Router();\n\n// Add request logging middleware at the top of the file\nrouter.use((req, res, next) => {\n  console.log(`[${req.method}] ${req.originalUrl} - Body:`, req.body);\n  next();\n});\n\n// Check if MongoDB is connected\nconst isMongoConnected = () => {\n  return User.db.readyState === 1;\n};\n\n// Generate JWT token\nconst generateToken = (userId, role) => {\n  return jwt.sign(\n    { userId, role },\n    process.env.JWT_SECRET || 'your-secret-key',\n    { expiresIn: '7d' }\n  );\n};\n\n// @route   POST /api/auth/register\n// @desc    Register a new user (optional email/password)\n// @access  Public\nrouter.post('/register', [\n  body('email').optional().isEmail().withMessage('Please enter a valid email'),\n  body('password').optional().isLength({ min: 6 }).withMessage('Password must be at least 6 characters'),\n  body('campusId').optional().isString().withMessage('Campus ID must be a string')\n], async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({ success: false, errors: errors.array() });\n    }\n\n    const { email, password, campusId } = req.body;\n    \n    // Generate anonymous ID\n    const anonymousId = uuidv4();\n    \n    // Use MongoDB if available, otherwise use memory store\n    if (isMongoConnected()) {\n      // Check if email already exists (if provided)\n      if (email) {\n        const existingUser = await User.findOne({ email });\n        if (existingUser) {\n          return res.status(400).json({\n            success: false,\n            message: 'User with this email already exists'\n          });\n        }\n      }\n\n      // Create user\n      const userData = {\n        anonymousId,\n        campusId,\n        isAnonymous: !email // Anonymous if no email provided\n      };\n\n      if (email) {\n        userData.email = email;\n      }\n\n      if (password) {\n        const salt = await bcrypt.genSalt(10);\n        userData.password = await bcrypt.hash(password, salt);\n      }\n\n      const user = await User.create(userData);\n\n      // Generate token\n      const token = generateToken(user._id, user.role);\n\n      res.status(201).json({\n        success: true,\n        token,\n        user: {\n          id: user._id,\n          anonymousId: user.anonymousId,\n          email: user.email,\n          role: user.role,\n          isAnonymous: user.isAnonymous,\n          campusId: user.campusId\n        }\n      });\n    } else {\n      // Use memory store\n      if (email) {\n        const existingUser = memoryStore.findUserByEmail(email);\n        if (existingUser) {\n          return res.status(400).json({\n            success: false,\n            message: 'User with this email already exists'\n          });\n        }\n      }\n\n      // Create user in memory store\n      const userData = {\n        anonymousId,\n        campusId,\n        isAnonymous: !email,\n        email: email || null,\n        password: password ? await bcrypt.hash(password, 10) : null,\n        role: 'user'\n      };\n\n      const user = memoryStore.createUser(userData);\n\n      // Generate token\n      const token = generateToken(user.id, user.role);\n\n      res.status(201).json({\n        success: true,\n        token,\n        user: {\n          id: user.id,\n          anonymousId: user.anonymousId,\n          email: user.email,\n          role: user.role,\n          isAnonymous: user.isAnonymous,\n          campusId: user.campusId\n        }\n      });\n    }"}, {"file_name": "Campus-Shield/docs/TECH_STACK_AND_WORKFLOW.md", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/docs/TECH_STACK_AND_WORKFLOW.md", "markdown_link": "- [Campus-Shield/docs/TECH_STACK_AND_WORKFLOW.md](https://github.com/sparrowdex/Campus-Shield/blob/main/docs/TECH_STACK_AND_WORKFLOW.md)\n", "code_chunk": "# CampusShield Tech Stack and Workflow Documentation\n\n## Recommended Tech Stack\n\n| Layer                | Technology Options                                                                                                          | Notes                                                     |\n|----------------------|----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n| **Front-End**        | React.js, React Native (mobile), Flutter (mobile)                                                                          | For web/mobile apps; Flutter enables true cross-platform  |\n| **Back-End/API**     | Node.js (Express.js), Python (FastAPI or Django)                                                                           | Scalable REST APIs, real-time features                    |\n| **Database**         | MongoDB (NoSQL), PostgreSQL (SQL)                                                                                          | MongoDB for flexible data; PostgreSQL for relational data |\n| **Authentication**   | Firebase Auth, Auth0, or custom JWT-based auth                                                                             | Secure sign-in, supports anonymity and OAuth              |\n| **Notifications**    | Firebase Cloud Messaging (push), Twilio (SMS), SendGrid (email)                                                            | Real-time and multi-channel notifications                 |\n| **AI/ML Integration**| Python (scikit-learn, Hugging Face Transformers, spaCy) via an API microservice                                           | For categorization, sentiment analysis, NLP               |\n| **Chat/Real-Time**   | Socket.io (Node.js), WebSockets, or Firebase Realtime Database                                                             | For admin-user anonymous chat, group support              |\n| **Maps/Heatmaps**    | Google Maps API, Mapbox, Leaflet.js                                                                                        | For live incident heatmaps                                |\n| **File Storage**     | AWS S3, Google Cloud Storage, Firebase Storage                                                                             | For reports with photos, voice, or video                  |\n| **Admin Dashboard**  | React (web-based), Chart.js/D3.js for analytics and visualizations                                                         | Data visualization and report management                  |\n| **Hosting/Infra**    | AWS, Google Cloud Platform, Azure, Vercel, Heroku                                                                          | Scalable and easy deployment                              |\n| **Security**         | HTTPS/SSL, end-to-end encryption (Signal Protocol, custom), privacy libraries                                              | To ensure report privacy and anonymous chat               |\n| **Localization**     | i18next, Google Cloud Translation                                                                                          | For multilingual support                                  |\n\n## MVP Tech Stack (Phase 1)\n\nFor the initial MVP, we'll use a simplified but scalable stack:\n\n- **Frontend**: React.js with Tailwind CSS\n- **Backend**: Node.js with Express.js\n- **Database**: MongoDB (flexible schema for reports)\n- **Real-time**: Socket.io for chat and live updates\n- **Authentication**: JWT-based with anonymous options\n- **Maps**: Leaflet.js for heatmap visualization\n- **File Storage**: Local storage initially, cloud storage later\n- **AI/ML**: Basic text classification using natural language processing\n\n## Suggested Workflow\n\n### 1. User Onboarding & Authentication\n- Users sign up with minimal data, choose anonymity (no personal info required).\n- Optional: Offer OAuth (Google, college email) for added features with clear privacy messaging."}, {"file_name": "Campus-Shield/server/services/socketService.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/socketService.js", "markdown_link": "- [Campus-Shield/server/services/socketService.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/socketService.js)\n", "code_chunk": "const jwt = require('jsonwebtoken');\nconst User = require('../models/User');\n\nconst initializeSocket = (io) => {\n  // Authentication middleware\n  io.use(async (socket, next) => {\n    try {\n      const token = socket.handshake.auth.token;\n      \n      if (!token) {\n        return next(new Error('Authentication error'));\n      }\n\n      const decoded = jwt.verify(token, process.env.JWT_SECRET || 'your-secret-key');\n      const user = await User.findById(decoded.userId);\n      \n      if (!user || !user.isActive) {\n        return next(new Error('User not found or inactive'));\n      }\n\n      socket.user = {\n        userId: user._id,\n        anonymousId: user.anonymousId,\n        role: user.role,\n        isAnonymous: user.isAnonymous\n      };\n\n      next();\n    } catch (error) {\n      next(new Error('Authentication error'));\n    }\n  });\n\n  io.on('connection', (socket) => {\n    console.log(`User connected: ${socket.user.anonymousId}`);\n\n    // Join user to their personal room\n    socket.join(`user_${socket.user.userId}`);\n\n    // Join admin to admin room if admin\n    if (socket.user.role === 'admin') {\n      socket.join('admin_room');\n    }\n\n    // Join chat room\n    socket.on('join_chat_room', (roomId) => {\n      socket.join(roomId);\n      console.log(`User ${socket.user.anonymousId} joined room: ${roomId}`);\n    });\n\n    // Leave chat room\n    socket.on('leave_chat_room', (roomId) => {\n      socket.leave(roomId);\n      console.log(`User ${socket.user.anonymousId} left room: ${roomId}`);\n    });\n\n    // Send message\n    socket.on('send_message', (data) => {\n      const { roomId, message } = data;\n      \n      // Emit to room\n      io.to(roomId).emit('new_message', {\n        id: Date.now().toString(),\n        senderId: socket.user.userId,\n        senderRole: socket.user.role,\n        message,\n        timestamp: new Date(),\n        isAnonymous: socket.user.isAnonymous\n      });\n\n      // Notify admins if message is from user\n      if (socket.user.role === 'user') {\n        io.to('admin_room').emit('user_message', {\n          roomId,\n          message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),\n          timestamp: new Date()\n        });\n      }\n    });\n\n    // Report status updates\n    socket.on('report_status_update', (data) => {\n      const { reportId, status, message } = data;\n      \n      // Notify user about their report update\n      io.to(`user_${socket.user.userId}`).emit('report_updated', {\n        reportId,\n        status,\n        message,\n        timestamp: new Date()\n      });\n    });\n\n    // Location-based alerts\n    socket.on('location_update', (data) => {\n      const { latitude, longitude } = data;\n      \n      // In a real implementation, you would check for nearby incidents\n      // and send alerts to users in high-report areas\n      console.log(`User ${socket.user.anonymousId} location: ${latitude}, ${longitude}`);\n    });\n\n    // Typing indicators\n    socket.on('typing_start', (roomId) => {\n      socket.to(roomId).emit('user_typing', {\n        userId: socket.user.userId,\n        isTyping: true\n      });\n    });\n\n    socket.on('typing_stop', (roomId) => {\n      socket.to(roomId).emit('user_typing', {\n        userId: socket.user.userId,\n        isTyping: false\n      });\n    });\n\n    // Disconnect\n    socket.on('disconnect', () => {\n      console.log(`User disconnected: ${socket.user.anonymousId}`);\n    });\n  });\n\n  // Global error handler\n  io.on('error', (error) => {\n    console.error('Socket.io error:', error);\n  });\n};\n\nmodule.exports = { initializeSocket };"}, {"file_name": "Campus-Shield/server/models/User.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/User.js", "markdown_link": "- [Campus-Shield/server/models/User.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/User.js)\n", "code_chunk": "const mongoose = require('mongoose');\nconst bcrypt = require('bcryptjs');\n\nconst userSchema = new mongoose.Schema({\n  // Minimal user data for privacy\n  anonymousId: {\n    type: String,\n    required: true,\n    unique: true,\n    index: true\n  },\n  \n  // Optional authenticated user data\n  email: {\n    type: String,\n    sparse: true, // Allows multiple null values\n    lowercase: true,\n    match: [/^\\w+([.-]?\\w+)*@\\w+([.-]?\\w+)*(\\.\\w{2,3})+$/, 'Please enter a valid email']\n  },\n  \n  password: {\n    type: String,\n    minlength: 6\n  },\n  \n  role: {\n    type: String,\n    enum: ['user', 'admin', 'moderator'],\n    default: 'user'\n  },\n  \n  // Privacy settings\n  isAnonymous: {\n    type: Boolean,\n    default: true\n  },\n  \n  // Campus affiliation (optional)\n  campusId: {\n    type: String,\n    index: true\n  },\n  \n  // User preferences\n  preferences: {\n    notifications: {\n      type: Boolean,\n      default: true\n    },\n    locationSharing: {\n      type: Boolean,\n      default: false\n    },\n    language: {\n      type: String,\n      default: 'en'\n    }\n  },\n  \n  // Privacy and security\n  lastActive: {\n    type: Date,\n    default: Date.now\n  },\n  \n  dataRetentionDate: {\n    type: Date,\n    default: () => new Date(Date.now() + 365 * 24 * 60 * 60 * 1000) // 1 year\n  },\n  \n  // Account status\n  isActive: {\n    type: Boolean,\n    default: true\n  },\n  \n  createdAt: {\n    type: Date,\n    default: Date.now\n  },\n  \n  updatedAt: {\n    type: Date,\n    default: Date.now\n  }\n});\n\n// Index for data cleanup\nuserSchema.index({ dataRetentionDate: 1 });\n\n// Pre-save middleware to hash password\nuserSchema.pre('save', async function(next) {\n  if (!this.isModified('password')) return next();\n  \n  if (this.password) {\n    const salt = await bcrypt.genSalt(parseInt(process.env.BCRYPT_ROUNDS) || 12);\n    this.password = await bcrypt.hash(this.password, salt);\n  }\n  \n  this.updatedAt = Date.now();\n  next();\n});\n\n// Method to check password\nuserSchema.methods.comparePassword = async function(candidatePassword) {\n  if (!this.password) return false;\n  return bcrypt.compare(candidatePassword, this.password);\n};\n\n// Method to update last active\nuserSchema.methods.updateLastActive = function() {\n  this.lastActive = new Date();\n  return this.save();\n};\n\n// Static method to create anonymous user\nuserSchema.statics.createAnonymousUser = function(anonymousId, campusId = null) {\n  return this.create({\n    anonymousId,\n    campusId,\n    isAnonymous: true\n  });\n};\n\n// Remove sensitive data when converting to JSON\nuserSchema.methods.toJSON = function() {\n  const user = this.toObject();\n  delete user.password;\n  return user;\n};\n\nmodule.exports = mongoose.model('User', userSchema);"}, {"file_name": "Campus-Shield/client/src/contexts/AuthContext.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/contexts/AuthContext.tsx", "markdown_link": "- [Campus-Shield/client/src/contexts/AuthContext.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/contexts/AuthContext.tsx)\n", "code_chunk": "import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport axios from 'axios';\n\n// Types\ninterface User {\n  id: string;\n  anonymousId: string;\n  email?: string;\n  role: 'user' | 'admin' | 'moderator';\n  isAnonymous: boolean;\n  campusId?: string;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  loading: boolean;\n  login: (email: string, password: string) => Promise<void>;\n  register: (email: string, password: string, campusId?: string) => Promise<void>;\n  loginAnonymous: (campusId?: string) => Promise<void>;\n  logout: () => void;\n  updatePreferences: (preferences: any) => Promise<void>;\n  adminLogin: (email: string, password: string) => Promise<void>;\n}\n\n// Create context\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\n// Auth provider component\nexport const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\n  const [user, setUser] = useState<User | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  // Set up axios defaults\n  useEffect(() => {\n    const token = localStorage.getItem('token');\n    if (token) {\n      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;\n    }\n  }, []);\n\n  // Check if user is logged in on app start\n  useEffect(() => {\n    const checkAuth = async () => {\n      const token = localStorage.getItem('token');\n      if (token) {\n        try {\n          const response = await axios.get(`${process.env.REACT_APP_API_URL}/api/auth/me`);\n          setUser(response.data.user);\n        } catch (error) {\n          localStorage.removeItem('token');\n          delete axios.defaults.headers.common['Authorization'];\n        }\n      }\n      setLoading(false);\n    };\n\n    checkAuth();\n  }, []);\n\n  const login = async (email: string, password: string) => {\n    try {\n      const response = await axios.post(`${process.env.REACT_APP_API_URL}/api/auth/login`, {\n        email,\n        password\n      });\n\n      const { token, user } = response.data;\n      localStorage.setItem('token', token);\n      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;\n      setUser(user);\n    } catch (error: any) {\n      throw new Error(error.response?.data?.message || 'Login failed');\n    }\n  };\n\n  const register = async (email: string, password: string, campusId?: string) => {\n    try {\n      const response = await axios.post(`${process.env.REACT_APP_API_URL}/api/auth/register`, {\n        email,\n        password,\n        campusId\n      });\n\n      const { token, user } = response.data;\n      localStorage.setItem('token', token);\n      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;\n      setUser(user);\n    } catch (error: any) {\n      throw new Error(error.response?.data?.message || 'Registration failed');\n    }\n  };\n\n  const loginAnonymous = async (campusId?: string) => {\n    try {\n      const response = await axios.post(`${process.env.REACT_APP_API_URL}/api/auth/anonymous`, {\n        campusId\n      });\n\n      const { token, user } = response.data;\n      localStorage.setItem('token', token);\n      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;\n      setUser(user);\n    } catch (error: any) {\n      throw new Error(error.response?.data?.message || 'Anonymous login failed');\n    }\n  };\n\n  const logout = () => {\n    localStorage.removeItem('token');\n    delete axios.defaults.headers.common['Authorization'];\n    setUser(null);\n  };\n\n  const updatePreferences = async (preferences: any) => {\n    try {\n      const response = await axios.put(`${process.env.REACT_APP_API_URL}/api/auth/preferences`, preferences);\n      // Update user preferences in state if needed\n    } catch (error: any) {\n      throw new Error(error.response?.data?.message || 'Failed to update preferences');\n    }\n  };"}, {"file_name": "Campus-Shield/client/src/components/layout/Navbar.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout/Navbar.tsx", "markdown_link": "- [Campus-Shield/client/src/components/layout/Navbar.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout/Navbar.tsx)\n", "code_chunk": "{/* Mobile menu */}\n      {isMenuOpen && (\n        <div className=\"sm:hidden\">\n          <div className=\"pt-2 pb-3 space-y-1\">\n            {navigation.map((item) => (\n              <Link\n                key={item.name}\n                to={item.href}\n                className=\"block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300 transition-colors duration-200\"\n                onClick={() => setIsMenuOpen(false)}\n              >\n                {item.name}\n              </Link>\n            ))}\n          </div>\n          {/* Notification Bell in mobile menu */}\n          {user && (\n            <div className=\"flex items-center px-4 pt-2 pb-1 border-t border-gray-200\">\n              <button\n                className=\"relative focus:outline-none mr-4\"\n                onClick={() => { setNotifOpen(true); setIsMenuOpen(false); }}\n                aria-label=\"Open notifications\"\n              >\n                <BellIcon className=\"h-6 w-6 text-gray-600 hover:text-primary-600\" />\n                {unread.length > 0 && (\n                  <span className=\"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 font-bold shadow\">\n                    {unread.length}\n                  </span>\n                )}\n              </button>\n              <div className=\"flex items-center space-x-2 text-sm text-gray-700\">\n                <UserIcon className=\"h-4 w-4\" />\n                <span>\n                  {user.isAnonymous ? 'Anonymous User' : user.email}\n                </span>\n                {user.role === 'admin' && (\n                  <span className=\"badge badge-info\">Admin</span>\n                )}\n                {user.role === 'moderator' && (\n                  <span className=\"badge badge-warning\">Moderator</span>\n                )}\n              </div>\n            </div>\n          )}\n          {user ? (\n            <div className=\"pt-2 pb-3\">\n              {user.role !== 'admin' && (\n                <Link to=\"/request-admin\" className=\"block px-4 py-2 text-base text-primary-600 hover:text-primary-500\" onClick={() => setIsMenuOpen(false)}>\n                  Request Admin\n                </Link>\n              )}\n              <button\n                onClick={handleLogout}\n                className=\"block w-full text-left px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n              >\n                Logout\n              </button>\n            </div>\n          ) : (\n            <div className=\"pt-4 pb-3 border-t border-gray-200\">\n              <div className=\"space-y-1\">\n                <Link\n                  to=\"/login\"\n                  className=\"block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n                  onClick={() => setIsMenuOpen(false)}\n                >\n                  Login\n                </Link>\n                <Link\n                  to=\"/register\"\n                  className=\"block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n                  onClick={() => setIsMenuOpen(false)}\n                >\n                  Register\n                </Link>\n                <Link\n                  to=\"/admin-login\"\n                  className=\"block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n                  onClick={() => setIsMenuOpen(false)}\n                >\n                  Admin Access\n                </Link>\n              </div>\n            </div>\n          )}\n        </div>\n      )}"}, {"file_name": "Campus-Shield/client/src/pages/Chat.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Chat.tsx", "markdown_link": "- [Campus-Shield/client/src/pages/Chat.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Chat.tsx)\n", "code_chunk": "import React, { useState, useEffect, useRef, useContext } from 'react';\nimport { \n  PaperAirplaneIcon,\n  UserIcon,\n  ShieldCheckIcon,\n  ClockIcon,\n  ExclamationTriangleIcon,\n  ChatBubbleLeftRightIcon,\n  ArrowLeftIcon\n} from '@heroicons/react/24/outline';\nimport LoadingSpinner from '../components/common/LoadingSpinner';\nimport { useLocation } from 'react-router-dom';\nimport { io, Socket } from 'socket.io-client';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useNotifications } from '../contexts/NotificationContext';\n\ninterface Message {\n  id: string;\n  senderId: string;\n  senderRole: 'user' | 'admin' | 'moderator';\n  message: string;\n  timestamp: string;\n  isAnonymous: boolean;\n}\n\ninterface ChatRoom {\n  _id: string;\n  reportId: string;\n  participants: string[];\n  lastMessage: Message | null;\n  createdAt: string;\n}\n\nconst Chat: React.FC = () => {\n  const location = useLocation();\n  const [chatRooms, setChatRooms] = useState<ChatRoom[]>([]);\n  const [selectedRoom, setSelectedRoom] = useState<string | null>(null);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [sending, setSending] = useState(false);\n  const [error, setError] = useState('');\n  const [reportStatus, setReportStatus] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const socketRef = useRef<Socket | null>(null);\n  const { user } = useAuth();\n  const { notifications, markAsRead } = useNotifications();\n  const [showSidebarMobile, setShowSidebarMobile] = useState(true); // mobile: show sidebar or chat\n  const [showDisclaimerModal, setShowDisclaimerModal] = useState(false);\n\n  useEffect(() => {\n    // Connect to Socket.IO server\n    const token = localStorage.getItem('token');\n    const socket = io(process.env.REACT_APP_SOCKET_URL, {\n      auth: { token },\n      transports: ['websocket']\n    });\n    socketRef.current = socket;\n    return () => {\n      socket.disconnect();\n    };\n  }, []);\n\n  useEffect(() => {\n    fetchChatRooms();\n  }, []);\n\n  // Auto-select chat room if reportId is in the URL\n  useEffect(() => {\n    const params = new URLSearchParams(location.search);\n    const reportId = params.get('reportId');\n    if (reportId) {\n      const room = chatRooms.find(r => r.reportId === reportId);\n      if (room) {\n        setSelectedRoom(room._id);\n      } else {\n        // Create the chat room if it doesn't exist\n        const createRoom = async () => {\n          try {\n            const response = await fetch(`${process.env.REACT_APP_API_URL}/api/chat/room`, {\n              method: 'POST',\n              headers: {\n                'Authorization': `Bearer ${localStorage.getItem('token')}`,\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({ reportId })\n            });\n            const data = await response.json();\n            if (response.ok && data.room) {\n              setChatRooms(prev => {\n                // Remove any room with the same roomId or reportId\n                const filtered = prev.filter(r => r._id !== data.room._id && r.reportId !== data.room.reportId);\n                return [...filtered, data.room];\n              });\n              setSelectedRoom(data.room._id);\n            }\n          } catch (err) {\n            // Optionally handle error\n          }\n        };\n        createRoom();\n      }\n    }\n  }, [location.search, chatRooms]);\n\n  useEffect(() => {\n    if (selectedRoom && socketRef.current) {\n      // Join the selected room\n      socketRef.current.emit('join_chat_room', selectedRoom);\n      // Listen for new messages\n      socketRef.current.on('new_message', (msg: Message) => {\n        setMessages(prev => [...prev, msg]);\n      });\n      return () => {\n        socketRef.current?.emit('leave_chat_room', selectedRoom);\n        socketRef.current?.off('new_message');\n      };\n    }\n  }, [selectedRoom]);"}, {"file_name": "Campus-Shield/client/src/pages/AdminRequests.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/AdminRequests.tsx", "markdown_link": "- [Campus-Shield/client/src/pages/AdminRequests.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/AdminRequests.tsx)\n", "code_chunk": "<div className=\"space-y-4\">\n                <div>\n                  <h3 className=\"font-medium text-gray-900 mb-2\">Applicant Information</h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <span className=\"text-sm font-medium text-gray-700\">Email:</span>\n                      <p className=\"text-sm text-gray-900\">{selectedRequest.user?.email}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-sm font-medium text-gray-700\">Role:</span>\n                      <p className=\"text-sm text-gray-900\">{selectedRequest.role}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-sm font-medium text-gray-700\">Department:</span>\n                      <p className=\"text-sm text-gray-900\">{selectedRequest.department}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-sm font-medium text-gray-700\">Urgency:</span>\n                      <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getUrgencyColor(selectedRequest.urgency)}`}>\n                        {selectedRequest.urgency.charAt(0).toUpperCase() + selectedRequest.urgency.slice(1)}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n\n                <div>\n                  <h3 className=\"font-medium text-gray-900 mb-2\">Experience</h3>\n                  <p className=\"text-sm text-gray-700 bg-gray-50 p-3 rounded\">{selectedRequest.experience}</p>\n                </div>\n\n                <div>\n                  <h3 className=\"font-medium text-gray-900 mb-2\">Current Responsibilities</h3>\n                  <p className=\"text-sm text-gray-700 bg-gray-50 p-3 rounded\">{selectedRequest.responsibilities}</p>\n                </div>\n\n                <div>\n                  <h3 className=\"font-medium text-gray-900 mb-2\">Reason for Admin Access</h3>\n                  <p className=\"text-sm text-gray-700 bg-gray-50 p-3 rounded\">{selectedRequest.reason}</p>\n                </div>\n\n                {selectedRequest.contactInfo && (\n                  <div>\n                    <h3 className=\"font-medium text-gray-900 mb-2\">Additional Contact</h3>\n                    <p className=\"text-sm text-gray-700 bg-gray-50 p-3 rounded\">{selectedRequest.contactInfo}</p>\n                  </div>\n                )}\n\n                {selectedRequest.status === 'pending' && (\n                  <div>\n                    <h3 className=\"font-medium text-gray-900 mb-2\">Review Notes</h3>\n                    <textarea\n                      value={reviewNotes}\n                      onChange={(e) => setReviewNotes(e.target.value)}\n                      className=\"input-field\"\n                      rows={3}\n                      placeholder=\"Add notes about your decision...\"\n                    />\n                  </div>\n                )}\n\n                {selectedRequest.status !== 'pending' && selectedRequest.reviewNotes && (\n                  <div>\n                    <h3 className=\"font-medium text-gray-900 mb-2\">Review Notes</h3>\n                    <p className=\"text-sm text-gray-700 bg-gray-50 p-3 rounded\">{selectedRequest.reviewNotes}</p>\n                  </div>\n                )}"}, {"file_name": "Campus-Shield/client/src/pages/Home.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Home.tsx", "markdown_link": "- [Campus-Shield/client/src/pages/Home.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Home.tsx)\n", "code_chunk": "{/* Features Section */}\n      <section className=\"bg-gray-50 py-16\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl md:text-4xl font-bold text-gray-900 mb-4\">\n              Why Choose CampusShield?\n            </h2>\n            <p className=\"text-lg text-gray-600 max-w-2xl mx-auto\">\n              Our privacy-first approach ensures you can report safety concerns without fear, \n              while powerful features help keep everyone informed and protected.\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8\">\n            {features.map((feature, index) => (\n              <div key={index} className=\"card hover:shadow-md transition-shadow duration-200\">\n                <div className=\"flex items-center mb-4\">\n                  <feature.icon className=\"h-8 w-8 text-primary-600 mr-3\" />\n                  <h3 className=\"text-lg font-semibold text-gray-900\">\n                    {feature.title}\n                  </h3>\n                </div>\n                <p className=\"text-gray-600\">\n                  {feature.description}\n                </p>\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n\n      {/* How It Works Section */}\n      <section className=\"bg-white py-16\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl md:text-4xl font-bold text-gray-900 mb-4\">\n              How It Works\n            </h2>\n            <p className=\"text-lg text-gray-600 max-w-2xl mx-auto\">\n              Simple, secure, and anonymous reporting in just a few steps.\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8\">\n            <div className=\"text-center\">\n              <div className=\"bg-primary-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4\">\n                <span className=\"text-2xl font-bold text-primary-600\">1</span>\n              </div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Report Incident</h3>\n              <p className=\"text-gray-600\">\n                Submit a detailed report with location, description, and optional media attachments.\n              </p>\n            </div>\n            \n            <div className=\"text-center\">\n              <div className=\"bg-primary-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4\">\n                <span className=\"text-2xl font-bold text-primary-600\">2</span>\n              </div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">AI Processing</h3>\n              <p className=\"text-gray-600\">\n                Our AI categorizes and prioritizes your report for appropriate response.\n              </p>\n            </div>\n            \n            <div className=\"text-center\">\n              <div className=\"bg-primary-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4\">\n                <span className=\"text-2xl font-bold text-primary-600\">3</span>\n              </div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">Stay Updated</h3>\n              <p className=\"text-gray-600\">\n                Receive updates on your report and chat with authorities if needed.\n              </p>\n            </div>\n          </div>\n        </div>\n      </section>"}]</code-reference>