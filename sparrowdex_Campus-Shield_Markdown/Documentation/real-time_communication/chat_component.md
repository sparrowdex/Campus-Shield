# Chat Component

## Chat Component Technical Documentation

<document-code-reference section="Chat Component Technical Documentation">
{"files": [
  {
    "name": "Campus-Shield/server/scripts/deduplicateChatParticipants.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/scripts/deduplicateChatParticipants.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/scripts"
  },
  {
    "name": "Campus-Shield/client/src/components/layout/Navbar.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout/Navbar.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout"
  },
  {
    "name": "Campus-Shield/client/src/pages/Chat.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Chat.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages"
  },
  {
    "name": "Campus-Shield/server/index.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server"
  }
]}
</document-code-reference>

<artifact ArtifactUUID="9c58dc74-c0ba-4563-b97e-b641ad4119b7">Real-time Communication Implementation</artifact>

The Chat component in the Campus-Shield project implements real-time communication between users and administrators. It utilizes Socket.IO for instant messaging and React hooks for state management.

### Core Functionality

1. Fetches chat rooms and messages from the server
2. Manages real-time message updates using Socket.IO
3. Handles user input and message sending
4. Displays chat history with proper formatting

### Key Files and Dependencies

- `client/src/pages/Chat.tsx`: Main chat component
- `server/models/ChatRoom.js`: MongoDB schema for chat rooms
- `server/models/Message.js`: MongoDB schema for individual messages
- `server/routes/chat.js`: API endpoints for chat operations
- `server/services/socketService.js`: Socket.IO event handlers

<artifact ArtifactUUID="e261a720-2852-4547-bd55-002cf1441544">State Management and Data Flow</artifact>

The Chat component uses React hooks for state management:

```typescript
const [chatRooms, setChatRooms] = useState<ChatRoom[]>([]);
const [selectedRoom, setSelectedRoom] = useState<string | null>(null);
const [messages, setMessages] = useState<Message[]>([]);
const [newMessage, setNewMessage] = useState('');
```

Data flow:
1. Fetch chat rooms on component mount
2. Select a room to load messages
3. Real-time updates via Socket.IO
4. Send new messages and update state

### Socket.IO Integration

The component establishes a Socket.IO connection:

```typescript
useEffect(() => {
  const socket = io(process.env.REACT_APP_SOCKET_URL, {
    auth: { token },
    transports: ['websocket']
  });
  socketRef.current = socket;
  return () => {
    socket.disconnect();
  };
}, []);
```

<artifact ArtifactUUID="b68a480e-87af-42f4-8d7b-3ab1b0cb1299">Message Handling and Display</artifact>

Messages are displayed using a combination of user roles and timestamps:

```typescript
{messages.map((message, index) => {
  const isCurrentUser = user && message.senderId === user.id;
  return (
    <div key={message.id}>
      {/* Message display logic */}
    </div>
  );
})}
```

### Security and Privacy

1. JWT authentication for API requests
2. Anonymous messaging options
3. Role-based access control

<artifact ArtifactUUID="1a3e8031-406e-48e1-b654-85374c019b04">Error Handling and Loading States</artifact>

The component implements error handling and loading states:

```typescript
{loading ? (
  <LoadingSpinner text="Loading chat rooms..." />
) : error ? (
  <div className="mb-6 bg-danger-50 border border-danger-200 rounded-md p-4">
    <p className="text-sm text-danger-700">{error}</p>
  </div>
) : (
  // Chat room and message display
)}
```

### Backend Integration

The chat functionality is supported by several backend components:

1. `ChatRoom` model for storing room information
2. `Message` model for individual messages
3. Express routes for CRUD operations on chats and messages
4. Socket.IO event handlers for real-time updates

```javascript
// server/routes/chat.js
router.post('/room/:roomId/message', auth, async (req, res) => {
  // Message creation logic
});
```

<artifact ArtifactUUID="92c7e03f-e7b7-4e48-9410-a1a1ca0ffe9e">AI-Powered Features</artifact>

The chat system integrates with an AI service for advanced features:

1. Message categorization
2. Sentiment analysis
3. Automated responses

These features are implemented in `server/services/aiService.js` and integrated into the chat flow.

## Performance Considerations

<document-code-reference section="Performance Considerations">
{"files": [
  {
    "name": "Campus-Shield/server/scripts/deduplicateChatParticipants.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/scripts/deduplicateChatParticipants.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server/scripts"
  },
  {
    "name": "Campus-Shield/client/src/components/layout/Navbar.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout/Navbar.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout"
  },
  {
    "name": "Campus-Shield/client/src/pages/Chat.tsx",
    "description": "Implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Chat.tsx",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages"
  },
  {
    "name": "Campus-Shield/server/index.js",
    "description": "JavaScript/TypeScript implementation file",
    "file_url": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js",
    "directory": "https:/github.com/sparrowdex/Campus-Shield/blob/main/server"
  }
]}
</document-code-reference>

1. Message pagination for large chat histories
2. Efficient real-time updates using Socket.IO
3. Caching of frequently accessed data

The Chat component is a critical part of the Campus-Shield system, providing secure and efficient communication between users and administrators.
## References:
### Code:
<code-reference uuid='5a9a5271-fece-41ab-97e9-afc4937d4b58'>[{"file_name": "Campus-Shield/server/index.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js", "markdown_link": "- [Campus-Shield/server/index.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/index.js)\n", "code_chunk": "const express = require('express');\nconst http = require('http');\nconst socketIo = require('socket.io');\nconst cors = require('cors');\nconst helmet = require('helmet');\nconst compression = require('compression');\nconst morgan = require('morgan');\nconst rateLimit = require('express-rate-limit');\nconst path = require('path');\nrequire('dotenv').config();\nconst mongoose = require('mongoose');\n\n// Debug environment variables\nconsole.log('\ud83d\udd0d Environment variables check:');\nconsole.log('NODE_ENV:', process.env.NODE_ENV);\nconsole.log('PORT:', process.env.PORT);\nconsole.log('MONGODB_URI exists:', !!process.env.MONGODB_URI);\nconsole.log('MONGODB_URI length:', process.env.MONGODB_URI ? process.env.MONGODB_URI.length : 0);\nconsole.log('All env vars:', Object.keys(process.env).filter(key => key.includes('MONGO') || key.includes('MONGODB')));\n\nconst connectDB = require('./config/database');\nconst authRoutes = require('./routes/auth');\nconst reportRoutes = require('./routes/reports');\nconst chatRoutes = require('./routes/chat');\nconst adminRoutes = require('./routes/admin');\nconst notificationsRoutes = require('./routes/notifications');\nconst { initializeSocket } = require('./services/socketService');\nconst { errorHandler } = require('./middleware/errorHandler');\n\nconst app = express();\nconst server = http.createServer(app);\nconst io = socketIo(server, {\n  cors: {\n    origin: process.env.CORS_ORIGIN || \"http://localhost:3000\",\n    methods: [\"GET\", \"POST\"]\n  }\n});\n\n// Connect to MongoDB (non-blocking)\nconnectDB().catch(err => {\n  console.error('Failed to connect to database:', err);\n  // Don't exit the process, let it continue\n});\n\n// Initialize Socket.io\ninitializeSocket(io);\n\n// Security middleware\napp.use(helmet({\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n      scriptSrc: [\"'self'\"],\n      imgSrc: [\"'self'\", \"[REMOVED_DATA_URI]\n      connectSrc: [\"'self'\", \"ws:\", \"wss:\"]\n    }\n  }\n}));\n\n// Rate limiting\nconst limiter = rateLimit({\n  windowMs: parseInt(process.env.RATE_LIMIT_WINDOW) || 15 * 60 * 1000, // 15 minutes\n  max: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS) || 100,\n  message: 'Too many requests from this IP, please try again later.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\napp.use('/api/', limiter);\n\n// Middleware\napp.use(compression());\napp.use(morgan('combined'));\n// Apply CORS globally before all routes\nconst allowedOrigins = process.env.CORS_ORIGIN\n  ? process.env.CORS_ORIGIN.split(',').map(origin => origin.trim())\n  : [\"http://localhost:3000\"];\nconsole.log('Allowed CORS origins:', allowedOrigins);\n\napp.use(cors({\n  origin: function(origin, callback) {\n    if (!origin) return callback(null, true);\n    if (allowedOrigins.includes(origin)) return callback(null, true);\n    return callback(new Error('Not allowed by CORS'));\n  },\n  credentials: true\n}));\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// Serve uploaded files\napp.use('/uploads', express.static(path.join(__dirname, 'uploads')));\n\n// Health check endpoint\napp.get('/health', (req, res) => {\n  const health = {\n    status: 'OK',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    environment: process.env.NODE_ENV || 'development',\n    database: mongoose.connection.readyState === 1 ? 'connected' : 'disconnected'\n  };\n  \n  res.status(200).json(health);\n});\n\n// API Routes\napp.use('/api/auth', authRoutes);\napp.use('/api/reports', reportRoutes);\napp.use('/api/chat', chatRoutes);\napp.use('/api/admin', adminRoutes);\napp.use('/api/notifications', notificationsRoutes);\n\n// Error handling middleware\napp.use(errorHandler);\n\n// 404 handler\napp.use('*', (req, res) => {\n  res.status(404).json({\n    success: false,\n    message: 'Route not found'\n  });\n});\n\nconst PORT = process.env.PORT || 5000;"}, {"file_name": "Campus-Shield/client/src/pages/Home.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Home.tsx", "markdown_link": "- [Campus-Shield/client/src/pages/Home.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Home.tsx)\n", "code_chunk": "{/* CTA Section */}\n      <section className=\"bg-primary-600 text-white py-16\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center\">\n          <h2 className=\"text-3xl md:text-4xl font-bold mb-4\">\n            Ready to Make Campus Safer?\n          </h2>\n          <p className=\"text-xl text-primary-100 mb-8 max-w-2xl mx-auto\">\n            Join thousands of students who are already using CampusShield to report \n            safety concerns and stay informed.\n          </p>\n          {user ? (\n            <>\n              {user?.role === 'user' && (\n                <Link to=\"/report\" className=\"btn-primary bg-white text-primary-600 hover:bg-gray-100\">\n                  Report an Incident\n                </Link>\n              )}\n              {user?.role === 'admin' && (\n                <>\n                  <Link to=\"/admin\" className=\"btn-primary bg-white text-primary-600 hover:bg-gray-100\">\n                    Admin Dashboard\n                  </Link>\n                  <Link to=\"/chat\" className=\"btn-secondary bg-transparent border-white text-white hover:bg-white hover:text-primary-600\">\n                    Chat\n                  </Link>\n                </>\n              )}\n              {user?.role === 'moderator' && (\n                <>\n                  <Link to=\"/admin/requests\" className=\"btn-primary bg-white text-primary-600 hover:bg-gray-100\">\n                    Admin Requests\n                  </Link>\n                </>\n              )}\n              {!user && (\n                <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n                  <Link to=\"/register\" className=\"btn-primary bg-white text-primary-600 hover:bg-gray-100\">\n                    Get Started Now\n                  </Link>\n                  <Link to=\"/login\" className=\"btn-secondary bg-transparent border-white text-white hover:bg-white hover:text-primary-600\">\n                    Login\n                  </Link>\n                </div>\n              )}\n            </>\n          ) : (\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n              <Link to=\"/register\" className=\"btn-primary bg-white text-primary-600 hover:bg-gray-100\">\n                Get Started Now\n              </Link>\n              <Link to=\"/login\" className=\"btn-secondary bg-transparent border-white text-white hover:bg-white hover:text-primary-600\">\n                Login\n              </Link>\n            </div>\n          )}\n        </div>\n      </section>\n\n      {/* Emergency Notice */}\n      <div className=\"bg-danger-50 border-l-4 border-danger-400 p-4\">\n        <div className=\"flex\">\n          <ExclamationTriangleIcon className=\"h-5 w-5 text-danger-400\" />\n          <div className=\"ml-3\">\n            <p className=\"text-sm text-danger-700\">\n              <strong>Emergency?</strong> If you're in immediate danger, call campus security or 911 immediately. \n              CampusShield is for non-emergency safety reporting.\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default Home;"}, {"file_name": "Campus-Shield/server/services/memoryStore.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/memoryStore.js", "markdown_link": "- [Campus-Shield/server/services/memoryStore.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/memoryStore.js)\n", "code_chunk": "// Admin request operations\n  createAdminRequest(userId, requestData) {\n    const request = {\n      id: this.nextRequestId.toString(),\n      userId,\n      ...requestData,\n      status: 'pending', // pending, approved, rejected\n      createdAt: new Date().toISOString(),\n      reviewedBy: null,\n      reviewedAt: null,\n      reviewNotes: null\n    };\n    this.adminRequests.set(request.id, request);\n    this.nextRequestId++;\n    return request;\n  }\n\n  getAdminRequests(status = null) {\n    const requests = Array.from(this.adminRequests.values());\n    if (status) {\n      return requests.filter(req => req.status === status);\n    }\n    return requests;\n  }\n\n  updateAdminRequest(requestId, updates) {\n    const request = this.adminRequests.get(requestId);\n    if (request) {\n      Object.assign(request, updates, { \n        reviewedAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString()\n      });\n      this.adminRequests.set(requestId, request);\n      return request;\n    }\n    return null;\n  }\n\n  approveAdminRequest(requestId, approvedBy, notes = '') {\n    const request = this.updateAdminRequest(requestId, {\n      status: 'approved',\n      reviewedBy: approvedBy,\n      reviewNotes: notes\n    });\n\n    if (request) {\n      // Promote user to admin\n      this.updateUser(request.userId, { role: 'admin' });\n    }\n\n    return request;\n  }\n\n  rejectAdminRequest(requestId, rejectedBy, notes = '') {\n    return this.updateAdminRequest(requestId, {\n      status: 'rejected',\n      reviewedBy: rejectedBy,\n      reviewNotes: notes\n    });\n  }\n\n  // Report operations\n  createReport(reportData) {\n    const report = {\n      id: this.nextReportId.toString(),\n      ...reportData,\n      status: 'pending',\n      priority: 'medium',\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString(),\n      attachments: [],\n      publicUpdates: []\n    };\n    this.reports.set(report.id, report);\n    this.nextReportId++;\n    return report;\n  }\n\n  findReportsByUserId(userId) {\n    const userReports = [];\n    for (const report of this.reports.values()) {\n      if (report.userId === userId) {\n        userReports.push(report);\n      }\n    }\n    return userReports;\n  }\n\n  findReportById(id) {\n    return this.reports.get(id) || null;\n  }\n\n  updateReport(id, updates) {\n    const report = this.reports.get(id);\n    if (report) {\n      Object.assign(report, updates, { updatedAt: new Date().toISOString() });\n      this.reports.set(id, report);\n      return report;\n    }\n    return null;\n  }\n\n  // Chat operations\n  createChatRoom(roomData) {\n    const room = {\n      roomId: this.nextRoomId.toString(),\n      ...roomData,\n      createdAt: new Date().toISOString(),\n      lastMessage: null\n    };\n    this.chatRooms.set(room.roomId, room);\n    this.nextRoomId++;\n    return room;\n  }\n\n  findChatRoomByReportId(reportId) {\n    for (const room of this.chatRooms.values()) {\n      if (room.reportId === reportId) {\n        return room;\n      }\n    }\n    return null;\n  }\n\n  findChatRoomsByUserId(userId) {\n    const userRooms = [];\n    for (const room of this.chatRooms.values()) {\n      if (room.userId === userId) {\n        userRooms.push(room);\n      }\n    }\n    return userRooms;\n  }\n\n  createMessage(messageData) {\n    const message = {\n      id: this.nextMessageId.toString(),\n      ...messageData,\n      timestamp: new Date().toISOString()\n    };\n    this.messages.set(message.id, message);\n    this.nextMessageId++;\n    return message;\n  }\n\n  findMessagesByRoomId(roomId) {\n    const roomMessages = [];\n    for (const message of this.messages.values()) {\n      if (message.roomId === roomId) {\n        roomMessages.push(message);\n      }\n    }\n    return roomMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n  }\n\n  // Admin operations\n  getAllReports() {\n    return Array.from(this.reports.values());\n  }\n\n  getAllUsers() {\n    return Array.from(this.users.values());\n  }"}, {"file_name": "Campus-Shield/docs/TECH_STACK_AND_WORKFLOW.md", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/docs/TECH_STACK_AND_WORKFLOW.md", "markdown_link": "- [Campus-Shield/docs/TECH_STACK_AND_WORKFLOW.md](https://github.com/sparrowdex/Campus-Shield/blob/main/docs/TECH_STACK_AND_WORKFLOW.md)\n", "code_chunk": "# CampusShield Tech Stack and Workflow Documentation\n\n## Recommended Tech Stack\n\n| Layer                | Technology Options                                                                                                          | Notes                                                     |\n|----------------------|----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n| **Front-End**        | React.js, React Native (mobile), Flutter (mobile)                                                                          | For web/mobile apps; Flutter enables true cross-platform  |\n| **Back-End/API**     | Node.js (Express.js), Python (FastAPI or Django)                                                                           | Scalable REST APIs, real-time features                    |\n| **Database**         | MongoDB (NoSQL), PostgreSQL (SQL)                                                                                          | MongoDB for flexible data; PostgreSQL for relational data |\n| **Authentication**   | Firebase Auth, Auth0, or custom JWT-based auth                                                                             | Secure sign-in, supports anonymity and OAuth              |\n| **Notifications**    | Firebase Cloud Messaging (push), Twilio (SMS), SendGrid (email)                                                            | Real-time and multi-channel notifications                 |\n| **AI/ML Integration**| Python (scikit-learn, Hugging Face Transformers, spaCy) via an API microservice                                           | For categorization, sentiment analysis, NLP               |\n| **Chat/Real-Time**   | Socket.io (Node.js), WebSockets, or Firebase Realtime Database                                                             | For admin-user anonymous chat, group support              |\n| **Maps/Heatmaps**    | Google Maps API, Mapbox, Leaflet.js                                                                                        | For live incident heatmaps                                |\n| **File Storage**     | AWS S3, Google Cloud Storage, Firebase Storage                                                                             | For reports with photos, voice, or video                  |\n| **Admin Dashboard**  | React (web-based), Chart.js/D3.js for analytics and visualizations                                                         | Data visualization and report management                  |\n| **Hosting/Infra**    | AWS, Google Cloud Platform, Azure, Vercel, Heroku                                                                          | Scalable and easy deployment                              |\n| **Security**         | HTTPS/SSL, end-to-end encryption (Signal Protocol, custom), privacy libraries                                              | To ensure report privacy and anonymous chat               |\n| **Localization**     | i18next, Google Cloud Translation                                                                                          | For multilingual support                                  |\n\n## MVP Tech Stack (Phase 1)\n\nFor the initial MVP, we'll use a simplified but scalable stack:\n\n- **Frontend**: React.js with Tailwind CSS\n- **Backend**: Node.js with Express.js\n- **Database**: MongoDB (flexible schema for reports)\n- **Real-time**: Socket.io for chat and live updates\n- **Authentication**: JWT-based with anonymous options\n- **Maps**: Leaflet.js for heatmap visualization\n- **File Storage**: Local storage initially, cloud storage later\n- **AI/ML**: Basic text classification using natural language processing\n\n## Suggested Workflow\n\n### 1. User Onboarding & Authentication\n- Users sign up with minimal data, choose anonymity (no personal info required).\n- Optional: Offer OAuth (Google, college email) for added features with clear privacy messaging."}, {"file_name": "Campus-Shield/server/services/socketService.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/socketService.js", "markdown_link": "- [Campus-Shield/server/services/socketService.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/services/socketService.js)\n", "code_chunk": "const jwt = require('jsonwebtoken');\nconst User = require('../models/User');\n\nconst initializeSocket = (io) => {\n  // Authentication middleware\n  io.use(async (socket, next) => {\n    try {\n      const token = socket.handshake.auth.token;\n      \n      if (!token) {\n        return next(new Error('Authentication error'));\n      }\n\n      const decoded = jwt.verify(token, process.env.JWT_SECRET || 'your-secret-key');\n      const user = await User.findById(decoded.userId);\n      \n      if (!user || !user.isActive) {\n        return next(new Error('User not found or inactive'));\n      }\n\n      socket.user = {\n        userId: user._id,\n        anonymousId: user.anonymousId,\n        role: user.role,\n        isAnonymous: user.isAnonymous\n      };\n\n      next();\n    } catch (error) {\n      next(new Error('Authentication error'));\n    }\n  });\n\n  io.on('connection', (socket) => {\n    console.log(`User connected: ${socket.user.anonymousId}`);\n\n    // Join user to their personal room\n    socket.join(`user_${socket.user.userId}`);\n\n    // Join admin to admin room if admin\n    if (socket.user.role === 'admin') {\n      socket.join('admin_room');\n    }\n\n    // Join chat room\n    socket.on('join_chat_room', (roomId) => {\n      socket.join(roomId);\n      console.log(`User ${socket.user.anonymousId} joined room: ${roomId}`);\n    });\n\n    // Leave chat room\n    socket.on('leave_chat_room', (roomId) => {\n      socket.leave(roomId);\n      console.log(`User ${socket.user.anonymousId} left room: ${roomId}`);\n    });\n\n    // Send message\n    socket.on('send_message', (data) => {\n      const { roomId, message } = data;\n      \n      // Emit to room\n      io.to(roomId).emit('new_message', {\n        id: Date.now().toString(),\n        senderId: socket.user.userId,\n        senderRole: socket.user.role,\n        message,\n        timestamp: new Date(),\n        isAnonymous: socket.user.isAnonymous\n      });\n\n      // Notify admins if message is from user\n      if (socket.user.role === 'user') {\n        io.to('admin_room').emit('user_message', {\n          roomId,\n          message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),\n          timestamp: new Date()\n        });\n      }\n    });\n\n    // Report status updates\n    socket.on('report_status_update', (data) => {\n      const { reportId, status, message } = data;\n      \n      // Notify user about their report update\n      io.to(`user_${socket.user.userId}`).emit('report_updated', {\n        reportId,\n        status,\n        message,\n        timestamp: new Date()\n      });\n    });\n\n    // Location-based alerts\n    socket.on('location_update', (data) => {\n      const { latitude, longitude } = data;\n      \n      // In a real implementation, you would check for nearby incidents\n      // and send alerts to users in high-report areas\n      console.log(`User ${socket.user.anonymousId} location: ${latitude}, ${longitude}`);\n    });\n\n    // Typing indicators\n    socket.on('typing_start', (roomId) => {\n      socket.to(roomId).emit('user_typing', {\n        userId: socket.user.userId,\n        isTyping: true\n      });\n    });\n\n    socket.on('typing_stop', (roomId) => {\n      socket.to(roomId).emit('user_typing', {\n        userId: socket.user.userId,\n        isTyping: false\n      });\n    });\n\n    // Disconnect\n    socket.on('disconnect', () => {\n      console.log(`User disconnected: ${socket.user.anonymousId}`);\n    });\n  });\n\n  // Global error handler\n  io.on('error', (error) => {\n    console.error('Socket.io error:', error);\n  });\n};\n\nmodule.exports = { initializeSocket };"}, {"file_name": "Campus-Shield/client/src/components/layout/Navbar.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout/Navbar.tsx", "markdown_link": "- [Campus-Shield/client/src/components/layout/Navbar.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/components/layout/Navbar.tsx)\n", "code_chunk": "{/* Mobile menu */}\n      {isMenuOpen && (\n        <div className=\"sm:hidden\">\n          <div className=\"pt-2 pb-3 space-y-1\">\n            {navigation.map((item) => (\n              <Link\n                key={item.name}\n                to={item.href}\n                className=\"block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300 transition-colors duration-200\"\n                onClick={() => setIsMenuOpen(false)}\n              >\n                {item.name}\n              </Link>\n            ))}\n          </div>\n          {/* Notification Bell in mobile menu */}\n          {user && (\n            <div className=\"flex items-center px-4 pt-2 pb-1 border-t border-gray-200\">\n              <button\n                className=\"relative focus:outline-none mr-4\"\n                onClick={() => { setNotifOpen(true); setIsMenuOpen(false); }}\n                aria-label=\"Open notifications\"\n              >\n                <BellIcon className=\"h-6 w-6 text-gray-600 hover:text-primary-600\" />\n                {unread.length > 0 && (\n                  <span className=\"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 font-bold shadow\">\n                    {unread.length}\n                  </span>\n                )}\n              </button>\n              <div className=\"flex items-center space-x-2 text-sm text-gray-700\">\n                <UserIcon className=\"h-4 w-4\" />\n                <span>\n                  {user.isAnonymous ? 'Anonymous User' : user.email}\n                </span>\n                {user.role === 'admin' && (\n                  <span className=\"badge badge-info\">Admin</span>\n                )}\n                {user.role === 'moderator' && (\n                  <span className=\"badge badge-warning\">Moderator</span>\n                )}\n              </div>\n            </div>\n          )}\n          {user ? (\n            <div className=\"pt-2 pb-3\">\n              {user.role !== 'admin' && (\n                <Link to=\"/request-admin\" className=\"block px-4 py-2 text-base text-primary-600 hover:text-primary-500\" onClick={() => setIsMenuOpen(false)}>\n                  Request Admin\n                </Link>\n              )}\n              <button\n                onClick={handleLogout}\n                className=\"block w-full text-left px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n              >\n                Logout\n              </button>\n            </div>\n          ) : (\n            <div className=\"pt-4 pb-3 border-t border-gray-200\">\n              <div className=\"space-y-1\">\n                <Link\n                  to=\"/login\"\n                  className=\"block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n                  onClick={() => setIsMenuOpen(false)}\n                >\n                  Login\n                </Link>\n                <Link\n                  to=\"/register\"\n                  className=\"block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n                  onClick={() => setIsMenuOpen(false)}\n                >\n                  Register\n                </Link>\n                <Link\n                  to=\"/admin-login\"\n                  className=\"block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100\"\n                  onClick={() => setIsMenuOpen(false)}\n                >\n                  Admin Access\n                </Link>\n              </div>\n            </div>\n          )}\n        </div>\n      )}"}, {"file_name": "Campus-Shield/client/src/pages/Chat.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Chat.tsx", "markdown_link": "- [Campus-Shield/client/src/pages/Chat.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/Chat.tsx)\n", "code_chunk": "import React, { useState, useEffect, useRef, useContext } from 'react';\nimport { \n  PaperAirplaneIcon,\n  UserIcon,\n  ShieldCheckIcon,\n  ClockIcon,\n  ExclamationTriangleIcon,\n  ChatBubbleLeftRightIcon,\n  ArrowLeftIcon\n} from '@heroicons/react/24/outline';\nimport LoadingSpinner from '../components/common/LoadingSpinner';\nimport { useLocation } from 'react-router-dom';\nimport { io, Socket } from 'socket.io-client';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useNotifications } from '../contexts/NotificationContext';\n\ninterface Message {\n  id: string;\n  senderId: string;\n  senderRole: 'user' | 'admin' | 'moderator';\n  message: string;\n  timestamp: string;\n  isAnonymous: boolean;\n}\n\ninterface ChatRoom {\n  _id: string;\n  reportId: string;\n  participants: string[];\n  lastMessage: Message | null;\n  createdAt: string;\n}\n\nconst Chat: React.FC = () => {\n  const location = useLocation();\n  const [chatRooms, setChatRooms] = useState<ChatRoom[]>([]);\n  const [selectedRoom, setSelectedRoom] = useState<string | null>(null);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [sending, setSending] = useState(false);\n  const [error, setError] = useState('');\n  const [reportStatus, setReportStatus] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const socketRef = useRef<Socket | null>(null);\n  const { user } = useAuth();\n  const { notifications, markAsRead } = useNotifications();\n  const [showSidebarMobile, setShowSidebarMobile] = useState(true); // mobile: show sidebar or chat\n  const [showDisclaimerModal, setShowDisclaimerModal] = useState(false);\n\n  useEffect(() => {\n    // Connect to Socket.IO server\n    const token = localStorage.getItem('token');\n    const socket = io(process.env.REACT_APP_SOCKET_URL, {\n      auth: { token },\n      transports: ['websocket']\n    });\n    socketRef.current = socket;\n    return () => {\n      socket.disconnect();\n    };\n  }, []);\n\n  useEffect(() => {\n    fetchChatRooms();\n  }, []);\n\n  // Auto-select chat room if reportId is in the URL\n  useEffect(() => {\n    const params = new URLSearchParams(location.search);\n    const reportId = params.get('reportId');\n    if (reportId) {\n      const room = chatRooms.find(r => r.reportId === reportId);\n      if (room) {\n        setSelectedRoom(room._id);\n      } else {\n        // Create the chat room if it doesn't exist\n        const createRoom = async () => {\n          try {\n            const response = await fetch(`${process.env.REACT_APP_API_URL}/api/chat/room`, {\n              method: 'POST',\n              headers: {\n                'Authorization': `Bearer ${localStorage.getItem('token')}`,\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({ reportId })\n            });\n            const data = await response.json();\n            if (response.ok && data.room) {\n              setChatRooms(prev => {\n                // Remove any room with the same roomId or reportId\n                const filtered = prev.filter(r => r._id !== data.room._id && r.reportId !== data.room.reportId);\n                return [...filtered, data.room];\n              });\n              setSelectedRoom(data.room._id);\n            }\n          } catch (err) {\n            // Optionally handle error\n          }\n        };\n        createRoom();\n      }\n    }\n  }, [location.search, chatRooms]);\n\n  useEffect(() => {\n    if (selectedRoom && socketRef.current) {\n      // Join the selected room\n      socketRef.current.emit('join_chat_room', selectedRoom);\n      // Listen for new messages\n      socketRef.current.on('new_message', (msg: Message) => {\n        setMessages(prev => [...prev, msg]);\n      });\n      return () => {\n        socketRef.current?.emit('leave_chat_room', selectedRoom);\n        socketRef.current?.off('new_message');\n      };\n    }\n  }, [selectedRoom]);"}, {"file_name": "Campus-Shield/server/models/ChatRoom.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/ChatRoom.js", "markdown_link": "- [Campus-Shield/server/models/ChatRoom.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/models/ChatRoom.js)\n", "code_chunk": "const mongoose = require('mongoose');\n\nconst ChatRoomSchema = new mongoose.Schema({\n  reportId: { type: String, required: true, unique: true },\n  participants: [{ type: String, required: true }],\n  createdAt: { type: Date, default: Date.now }\n});\n\nmodule.exports = mongoose.model('ChatRoom', ChatRoomSchema);"}, {"file_name": "Campus-Shield/client/src/pages/AdminDashboard.tsx", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/AdminDashboard.tsx", "markdown_link": "- [Campus-Shield/client/src/pages/AdminDashboard.tsx](https://github.com/sparrowdex/Campus-Shield/blob/main/client/src/pages/AdminDashboard.tsx)\n", "code_chunk": "useEffect(() => {\n    fetchDashboardData();\n  }, []);\n\n  const fetchDashboardData = async () => {\n    try {\n      const [statsRes, activeChatsRes] = await Promise.all([\n        fetch(`${process.env.REACT_APP_API_URL}/api/admin/stats`, {\n          headers: {\n            'Authorization': `Bearer ${localStorage.getItem('token')}`\n          }\n        }),\n        fetch(`${process.env.REACT_APP_API_URL}/api/admin/active-chats`, {\n          headers: {\n            'Authorization': `Bearer ${localStorage.getItem('token')}`\n          }\n        })\n      ]);\n      if (statsRes.ok) {\n        const statsData = await statsRes.json();\n        setStats(statsData.stats);\n      }\n      if (activeChatsRes.ok) {\n        const activeChatsData = await activeChatsRes.json();\n        setActiveChats(activeChatsData.activeChats || 0);\n      }\n\n      // Fetch all reports\n      const reportsResponse = await fetch(`${process.env.REACT_APP_API_URL}/api/admin/reports`, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      if (reportsResponse.ok) {\n        const reportsData = await reportsResponse.json();\n        setReports(reportsData.reports || []);\n      }\n\n      // Fetch heatmap data\n      const heatmapResponse = await fetch(`${process.env.REACT_APP_API_URL}/api/reports/heatmap/data`, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      if (heatmapResponse.ok) {\n        const heatmapData = await heatmapResponse.json();\n        setHeatmapData(heatmapData.heatmapData || []);\n      }\n\n    } catch (err: any) {\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const updateReportStatus = async (reportId: string, newStatus: string) => {\n    try {\n      const response = await fetch(`${process.env.REACT_APP_API_URL}/api/admin/reports/${reportId}/status`, {\n        method: 'PATCH',\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('token')}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ status: newStatus })\n      });\n\n      if (response.ok) {\n        // Update the report in the local state\n        setReports(prev => prev.map(report => \n          report.id === reportId \n            ? { ...report, status: newStatus }\n            : report\n        ));\n        \n        // Refresh stats\n        fetchDashboardData();\n      }\n    } catch (err: any) {\n      setError(err.message);\n    }\n  };\n\n  const filteredReports = reports.filter(report => {\n    const matchesStatus = filter === 'all' || report.status === filter;\n    const matchesPriority = priorityFilter === 'all' || report.priority === priorityFilter;\n    const matchesCategory = categoryFilter === 'all' || report.category === categoryFilter;\n    return matchesStatus && matchesPriority && matchesCategory;\n  });\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  const getCategoryStats = () => {\n    const categoryCounts: { [key: string]: number } = {};\n    reports.forEach(report => {\n      const category = categoryLabels[report.category as keyof typeof categoryLabels] || report.category;\n      categoryCounts[category] = (categoryCounts[category] || 0) + 1;\n    });\n    return categoryCounts;\n  };\n\n  if (loading) {\n    return (\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"card\">\n          <LoadingSpinner text=\"Loading admin dashboard...\" />\n        </div>\n      </div>\n    );\n  }\n\n  const assignedToId =\n    selectedReport && selectedReport.assignedTo\n      ? isAssignedToObject(selectedReport.assignedTo)\n        ? selectedReport.assignedTo._id\n        : selectedReport.assignedTo\n      : null;"}, {"file_name": "Campus-Shield/server/routes/chat.js", "file_path": "https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/chat.js", "markdown_link": "- [Campus-Shield/server/routes/chat.js](https://github.com/sparrowdex/Campus-Shield/blob/main/server/routes/chat.js)\n", "code_chunk": "const express = require('express');\nconst { body, validationResult } = require('express-validator');\nconst auth = require('../middleware/auth');\nconst ChatRoom = require('../models/ChatRoom');\nconst Message = require('../models/Message');\nconst Report = require('../models/Report');\nconst Notification = require('../models/Notification');\n\nconst router = express.Router();\n\n// @route   POST /api/chat/room\n// @desc    Create or join a chat room\n// @access  Private\nrouter.post('/room', auth, async (req, res) => {\n  try {\n    const { reportId } = req.body;\n    if (!reportId) {\n      return res.status(400).json({ success: false, message: 'reportId is required' });\n    }\n    let room = await ChatRoom.findOne({ reportId });\n    if (!room) {\n      room = await ChatRoom.create({ reportId, participants: [req.user.userId] });\n    } else if (!room.participants.includes(req.user.userId)) {\n      room.participants.push(req.user.userId);\n      // Deduplicate participants\n      room.participants = Array.from(new Set(room.participants));\n      await room.save();\n    }\n    res.json({ success: true, room });\n  } catch (error) {\n    console.error('Create chat room error:', error);\n    res.status(500).json({ success: false, message: 'Server error creating chat room' });\n  }\n});\n\n// @route   GET /api/chat/room/:roomId/messages\n// @desc    Get chat messages\n// @access  Private\nrouter.get('/room/:roomId/messages', auth, async (req, res) => {\n  try {\n    const { roomId } = req.params;\n    const user = req.user;\n    const room = await ChatRoom.findById(roomId);\n    if (!room) {\n      return res.status(404).json({ success: false, message: 'Chat room not found' });\n    }\n    if (!room.participants.includes(user.userId)) {\n      return res.status(403).json({ success: false, message: 'Access denied' });\n    }\n    const messages = await Message.find({ roomId: room._id }).sort({ timestamp: 1 });\n    res.json({ success: true, messages });\n  } catch (error) {\n    console.error('Get messages error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});"}]</code-reference>